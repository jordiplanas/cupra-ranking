<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUPRA | Performance Dashboard</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        /* Estilos para las pestañas coherentes con tu diseño */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #1a2a4a; }
        .tab-btn { background: #1a2a4a; border: none; color: #888; padding: 12px 25px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { background: #c4a77d; color: #0a1128; }
        .panel { display: none; }
        .panel.active { display: block; }
        .block-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #2a3a5a; font-size: 0.85em; }
    </style>
</head>
<body>

    <header>
        <h1>CUPRA Ranking</h1>
        <div id="status">Cargando...</div>
    </header>

    <div class="controls">
        <input type="text" id="searchInput" placeholder="Buscar..." oninput="applyFilters()">
        <select id="countryFilter" onchange="applyFilters()">
            <option value="">Todos los Países</option>
        </select>
        <select id="jobFilter" onchange="applyFilters()">
            <option value="">Todos los Roles</option>
        </select>
        <button class="btn-csv" onclick="downloadCSV()">⬇️ Exportar CSV</button>
    </div>

    <div class="tabs">
        <button id="tab-teams-btn" class="tab-btn active" onclick="switchTab('teams')">EQUIPOS (Collaboration)</button>
        <button id="tab-indiv-btn" class="tab-btn" onclick="switchTab('individuals')">INDIVIDUAL (Global)</button>
    </div>

    <div id="panel-teams" class="table-container panel active">
        <table>
            <thead>
                <tr>
                    <th onclick="sortData('teams', 'country')">País ↕️</th>
                    <th onclick="sortData('teams', 'groupId')">Equipo ↕️</th>
                    <th onclick="sortData('teams', 'totalScore')">Puntos ↕️</th>
                    <th onclick="sortData('teams', 'totalDuration')">Tiempo ↕️</th>
                    <th>Participantes</th>
                </tr>
            </thead>
            <tbody id="teamsBody"></tbody>
        </table>
    </div>

    <div id="panel-individuals" class="table-container panel">
        <table>
            <thead>
                <tr>
                    <th onclick="sortData('individuals', 'fullName')">Participante ↕️</th>
                    <th onclick="sortData('individuals', 'country')">País ↕️</th>
                    <th onclick="sortData('individuals', 'job_role')">Rol ↕️</th>
                    <th onclick="sortData('individuals', 'totalScore')">Puntos ↕️</th>
                    <th onclick="sortData('individuals', 'totalDuration')">Tiempo ↕️</th>
                    <th>Detalles</th>
                </tr>
            </thead>
            <tbody id="indivBody"></tbody>
        </table>
    </div>

<script>
    let rawData = { teams: [], individuals: [] };
    let filteredData = { teams: [], individuals: [] };
    let currentTab = 'teams';
    let sortDir = -1;

    async function loadData() {
        try {
            const response = await fetch('/api/ranking-master');
            rawData = await response.json();
            
            populateFilter('countryFilter', [...new Set(rawData.individuals.map(u => u.country))]);
            populateFilter('jobFilter', [...new Set(rawData.individuals.map(u => u.job_role))]);

            applyFilters();
            document.getElementById('status').innerText = "Datos actualizados";
        } catch (err) {
            document.getElementById('status').innerHTML = '<b style="color:red">Error de conexión</b>';
        }
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(`panel-${tab}`).classList.add('active');
        document.getElementById(`tab-${tab === 'teams' ? 'teams' : 'indiv'}-btn`).classList.add('active');
    }

    function applyFilters() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const country = document.getElementById('countryFilter').value;
        const job = document.getElementById('jobFilter').value;

        filteredData.individuals = rawData.individuals.filter(u => 
            u.fullName.toLowerCase().includes(search) &&
            (!country || u.country === country) &&
            (!job || u.job_role === job)
        );

        filteredData.teams = rawData.teams.filter(t => 
            (!country || t.country === country) &&
            t.groupId.toLowerCase().includes(search)
        );

        renderTables();
    }

    function renderTables() {
        // Render Equipos
        document.getElementById('teamsBody').innerHTML = filteredData.teams.map(t => `
            <tr>
                <td><span class="badge">${t.country}</span></td>
                <td><strong>${t.groupId}</strong></td>
                <td class="score-total">${t.totalScore.toFixed(2)}</td>
                <td class="duration">${t.totalDuration.toFixed(1)}s</td>
                <td>
                    <details>
                        <summary>${Object.keys(t.members).length} miembros</summary>
                        <div class="block-list">
                            ${Object.values(t.members).map(m => `
                                <div class="block-item"><span>${m.name}</span><strong>${m.score.toFixed(1)} pts</strong></div>
                            `).join('')}
                        </div>
                    </details>
                </td>
            </tr>
        `).join('');

        // Render Individual
        document.getElementById('indivBody').innerHTML = filteredData.individuals.map(u => `
            <tr>
                <td><strong>${u.fullName}</strong></td>
                <td><span class="badge">${u.country}</span></td>
                <td><small>${u.job_role}</small></td>
                <td class="score-total">${u.totalScore.toFixed(2)}</td>
                <td class="duration">${u.totalDuration.toFixed(1)}s</td>
                <td>
                    <details>
                        <summary>${u.blocks.length} pruebas</summary>
                        <div class="block-list">
                            ${u.blocks.map(b => `
                                <div class="block-item"><span>${b.name}</span><span>${b.score} pts</span></div>
                            `).join('')}
                        </div>
                    </details>
                </td>
            </tr>
        `).join('');
    }

    function sortData(type, col) {
        sortDir *= -1;
        filteredData[type].sort((a, b) => {
            let vA = a[col], vB = b[col];
            return typeof vA === 'string' ? vA.localeCompare(vB) * sortDir : (vA - vB) * sortDir;
        });
        renderTables();
    }

    function populateFilter(id, items) {
        const select = document.getElementById(id);
        items.sort().forEach(item => {
            if(item && item !== 'N/A') {
                const opt = document.createElement('option');
                opt.value = item; opt.innerText = item;
                select.appendChild(opt);
            }
        });
    }

    function downloadCSV() {
        let csv = "\ufeffPosicion,Nombre/Equipo,Pais,Puntos,Tiempo\n";
        const target = currentTab === 'teams' ? filteredData.teams : filteredData.individuals;
        
        target.forEach((item, i) => {
            const name = currentTab === 'teams' ? item.groupId : item.fullName;
            csv += `${i+1},${name},${item.country},${item.totalScore.toFixed(2)},${item.totalDuration.toFixed(1)}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `cupra_ranking_${currentTab}.csv`;
        link.click();
    }

    loadData();
</script>
</body>
</html>