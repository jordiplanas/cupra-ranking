<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CUPRA | Performance Dashboard</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>

    <header>
        <h1>CUPRA Ranking</h1>
        <div id="status">Cargando...</div>
    </header>

    <div class="controls">
        <input type="text" id="searchInput" placeholder="Buscar por nombre..." oninput="applyFilters()">
        <select id="countryFilter" onchange="applyFilters()">
            <option value="">Todos los Países</option>
        </select>
        <select id="jobFilter" onchange="applyFilters()">
            <option value="">Todos los Roles</option>
        </select>
        <button class="btn-csv" onclick="downloadCSV()">⬇️ Exportar CSV</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th onclick="sortTable('index')">Pos. ↕️</th>
                    <th onclick="sortTable('fullName')">Participante ↕️</th>
                    <th onclick="sortTable('country')">País ↕️</th>
                    <th onclick="sortTable('job_role')">Rol ↕️</th>
                    <th onclick="sortTable('totalScore')">Puntos ↕️</th>
                    <th onclick="sortTable('totalDuration')">Tiempo (s) ↕️</th>
                    <th>Detalles</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

<script>
    let allUsers = [];
    let filteredUsers = [];
    let currentSort = { column: 'totalScore', direction: 'desc' };

    async function loadData() {
        try {
            const response = await fetch('/api/ranking');
            allUsers = await response.json();
            // Asignar índice inicial
            allUsers = allUsers.map((u, i) => ({ ...u, index: i + 1 }));
            
            populateFilter('countryFilter', [...new Set(allUsers.map(u => u.country))]);
            populateFilter('jobFilter', [...new Set(allUsers.map(u => u.job_role))]);

            applyFilters();
            document.getElementById('status').innerText = `Total: ${allUsers.length} participantes`;
        } catch (err) {
            document.getElementById('status').innerHTML = '<b style="color:red">Error de conexión</b>';
        }
    }

    function sortTable(column) {
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = (column === 'totalScore' || column === 'totalDuration') ? 'desc' : 'asc';
        }

        allUsers.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            if (typeof valA === 'string') {
                return currentSort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            }
            return currentSort.direction === 'asc' ? valA - valB : valB - valA;
        });

        applyFilters();
    }

    function applyFilters() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const country = document.getElementById('countryFilter').value;
        const job = document.getElementById('jobFilter').value;

        filteredUsers = allUsers.filter(u => {
            const matchesName = u.fullName.toLowerCase().includes(search);
            const matchesCountry = !country || u.country === country;
            const matchesJob = !job || u.job_role === job;
            return matchesName && matchesCountry && matchesJob;
        });

        renderTable(filteredUsers);
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = data.map(u => `
            <tr>
                <td><small>${u.index}</small></td>
                <td><strong>${u.fullName}</strong></td>
                <td><span class="badge">${u.country}</span></td>
                <td><small>${u.job_role}</small></td>
                <td class="score-total">${u.totalScore.toFixed(2)}</td>
                <td class="duration">${u.totalDuration.toFixed(1)}s</td>
                <td>
                    <details>
                        <summary>${u.blocks.length} pruebas</summary>
                        <div class="block-list">
                            ${u.blocks.map(b => `<div class="block-item"><span>${b.name}</span><span>${b.score} pts</span></div>`).join('')}
                        </div>
                    </details>
                </td>
            </tr>
        `).join('');
    }

    function populateFilter(id, items) {
        const select = document.getElementById(id);
        items.sort().forEach(item => {
            if(item && item !== 'N/A') {
                const opt = document.createElement('option');
                opt.value = item; opt.innerText = item;
                select.appendChild(opt);
            }
        });
    }

    function downloadCSV() {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Posicion,Nombre,Pais,Rol,Puntuacion,Tiempo\n";
        
        filteredUsers.forEach(u => {
            let row = `${u.index},${u.fullName},${u.country},${u.job_role},${u.totalScore},${u.totalDuration}`;
            csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "ranking_cupra.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    loadData();
</script>
</body>
</html>